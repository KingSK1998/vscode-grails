# Grails Language Server - Developer Guide

## Project Overview

- **Purpose**: Language Server Protocol (LSP) implementation for Groovy and Grails projects
- **Language**: Groovy 4.0.23+ with Java 17.0.8+ LTS
- **Framework**: Eclipse LSP4J 0.23.1 for LSP implementation
- **Build System**: Gradle 8.12+ with application plugin
- **Testing**: Spock Framework 2.3 with JUnit Jupiter
- **Status**: Single developer project, not open-source yet

## Key Architecture Components

### Core Services
- **GrailsLanguageServer**: Main LSP entry point implementing LanguageServer interface
- **GrailsService**: Central orchestration service managing all LSP features and project state
- **GrailsCompiler**: Thread-safe compilation engine with incremental updates and smart caching
- **GradleService**: Gradle Tooling API integration for dependency resolution and project building

### Provider System (Modular LSP Features)
- **Document Providers**: Completion, Hover, Definition, References, Diagnostics, Symbols, etc.
- **Workspace Providers**: Workspace symbols and project-wide operations
- **Completion Strategies**: Modular completion system with specialized strategies

### Package Structure
```
kingsk.grails.lsp/
├── core/                   # Core compilation and AST processing
│   ├── compiler/           # Groovy/Grails compilation engine
│   ├── gradle/             # Gradle integration and project building
│   └── visitor/            # AST visitors and analysis
├── model/                  # Data models and configuration
├── providersDocument/      # LSP textDocument feature providers
│   └── completions/        # Modular completion strategies
├── providersWorkspace/     # LSP workspace feature providers
├── services/               # Core services and utilities
└── utils/                  # Helper classes and utilities
```

## Development Best Practices

### Code Organization
- Use `@CompileStatic` annotation for performance-critical code
- Follow modular provider pattern for LSP features
- Implement specialized base classes for different test types
- Use central AST resolution architecture for performance

### Testing Standards
- **Framework**: Spock 2.3 with specialized base test classes
- **Base Classes**: `BaseLspSpec`, `CompletionTestSpec`, `DiagnosticsTestSpec`, etc.
- **Coverage**: JaCoCo with 60% minimum threshold
- **Project Types**: Support for DUMMY, GROOVY, and GRAILS test projects
- **Commands**: `./gradlew test`, `./gradlew jacocoTestReport`, `./gradlew checkAll`

### Logging Standards
- **Format**: `[COMPONENT] message` (e.g., `[COMPILER] Starting compilation`)
- **Components**: COMPILER, AST, COMPLETION, HOVER, DIAGNOSTICS, DEFINITION, WORKSPACE, GRADLE
- **Configuration**: Logback with both console and file output (`./logs/grails-language-server.log`)
- **Levels**: INFO for operations, WARN for issues, ERROR for failures

### Performance Guidelines
- **Compilation Speed**: Full project ~2-5 seconds, incremental ~50-200ms
- **Memory Efficiency**: Use intelligent state management and proper resource cleanup
- **Caching Strategy**: 
  - Node-level: On-demand evaluation (hover, inlay hints)
  - File-level: Re-evaluate on file changes (symbols, folding)
  - Workspace-level: Compute once during load (references, cross-file types)

## Important Files and Directories

### Configuration Files
- `build.gradle`: Main build configuration with Groovy, LSP4J, and testing dependencies
- `gradle.properties`: Gradle configuration with cache enabled
- `src/main/resources/logback.xml`: Logging configuration
- `src/test/resources/test-config.groovy`: Test environment configuration

### Documentation
- `README.md`: Comprehensive project overview and features
- `API.md`: Complete API documentation for all public interfaces
- `CONTRIBUTING.md`: Development guidelines and contribution process
- `CHANGELOG.md`: Version history and feature tracking
- `docs/TESTING.md`: Testing infrastructure and best practices
- `docs/COMPILER.md`: GrailsCompiler architecture details
- `docs/FEATURE_RESPONSIBILITIES.md`: Feature ownership matrix
- `docs/LOGGING_GUIDE.md`: Logging standards and practices

### Key Source Files
- `GrailsLanguageServer.groovy`: Main LSP entry point
- `GrailsService.groovy`: Central service orchestrator
- `GrailsCompiler.groovy`: Core compilation engine
- `BaseProvider.groovy`: Base class for all LSP providers
- `CompletionProvider.groovy`: Main completion implementation

## Development Workflow

### Building and Running
```bash
# Build the project
./gradlew build

# Run the language server
./gradlew run

# Run all tests with coverage
./gradlew checkAll
```

### Testing Approach
- Use appropriate base test class for feature being tested
- Follow Spock conventions with given/when/then structure
- Test with different project types (DUMMY, GROOVY, GRAILS)
- Maintain 60% minimum code coverage

### Feature Development
1. **Use Central AST Resolution**: Leverage existing AST compilation for performance
2. **Follow Provider Pattern**: Extend BaseProvider for new LSP features
3. **Implement Modular Strategies**: Use strategy pattern for complex features like completion
4. **Add Comprehensive Tests**: Use specialized test base classes
5. **Document APIs**: Update API.md for public interfaces

## Grails-Specific Features

### Artifact Support
- **Recognition**: Controllers, Services, Domains, TagLibs, Jobs, and more
- **Convention Awareness**: Full understanding of Grails project structure
- **Plugin Support**: Works with Grails plugins and extensions
- **Build Integration**: Gradle Tooling API for dependency resolution

### LSP Capabilities
- **Implemented**: Completion, Hover, Definition, References, Symbols, Diagnostics, Signature Help, Code Lens, Inlay Hints
- **Future**: Document Highlighting, Code Actions, Rename, Semantic Tokens, Formatting, Folding

## Common Patterns

### Error Handling
- Use graceful degradation for compilation errors
- Implement comprehensive error collection and reporting
- Maintain operation continuity despite individual failures

### State Management
- Use thread-safe operations for concurrent access
- Implement intelligent caching with proper invalidation
- Maintain minimal memory footprint with proper cleanup

### Integration Points
- Gradle Tooling API for project structure and dependencies
- Eclipse LSP4J for protocol implementation
- Groovy AST for code analysis and compilation
- Spock Framework for comprehensive testing

## Temporary Files Convention

- Prefix all temporary files with `tmp_rovodev_` for easy cleanup
- Clean up temporary files at the end of development tasks
- Use build directory for test workspaces: `build/test-workspaces`